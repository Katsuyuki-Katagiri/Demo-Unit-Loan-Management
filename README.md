# デモ機管理アプリ (Demo Unit Loan Management)

デモ機や医療機器の貸出・在庫管理を行うための Streamlit アプリケーションです。
在庫ごとのステータス管理、貸出・返却時の構成品チェック、写真記録、不具合（Issue）管理機能を備え、厳格なトレーサビリティを実現します。

## 主な機能

### 1. デザイン & UI
- **モダンでスタイリッシュなホワイトベースデザイン**: 視認性の高いフォントと、アクセントカラー（ディープブルー）を採用
- **カード型UI**: 各情報をカード形式で整理し、視認性を向上
- **Material Symbolsアイコン**: Google Material Symbolsを使用し、洗練された印象に統一

### 2. 在庫管理
- **カテゴリ管理**: 大分類（セルセーバー、IABP、電気メス等）ごとに機材を管理
- **統計情報**: カテゴリ内の機材ステータス集計（総台数、在庫あり、貸出中、要対応）を表示
- **ロット管理**: 機種ごとの実機（ロット/シリアル）ステータス管理
- **点検日管理**: 点検実施日・次回点検予定日の記録と表示

### 3. 貸出管理 (Checkout)
- **貸出登録**: 持出日、貸出先、目的、備考を記録。**青色のボタン**で直感的に操作可能
- **構成品チェック**: 機種や個体に応じたチェックリスト（OK/NG判定）
- **写真記録**: 貸出時の状態を写真で保存（必須）。カメラ撮影/ファイルアップロード対応
- **AssetmentNeo連携確認**: 外部システムへの登録確認チェック
- **異常検知**: NG項目がある場合、自動的に「要対応」ステータスへ移行

### 4. 返却管理 (Return)
- **返却登録**: 貸出履歴に基づく返却処理。**赤色のボタン**で直感的に操作可能
- **状態自動判定**: 返却時のチェック結果と既存の不具合状況に基づき、ステータスを自動更新
- **汚れチェック**: 返却時の清掃確認チェック機能
- **写真・チェック**: 返却時も貸出時と同様に写真とチェックリストを必須化

### 5. 貸出返却履歴
- **詳細履歴表示**: 貸出・返却の履歴をタイムライン形式で表示
- **構成品チェック詳細**: 各履歴を展開することで、その時点での構成品チェック結果を確認可能
- **写真表示**: 履歴ごとに記録された写真を表示
- **持出者表示**: 誰が持ち出したか（またはチェックを担当したか）を明記

### 6. 不具合・取消管理
- **Issue管理**: 不具合の記録と解消（Resolve）フロー
- **取消機能 (Undo)**: 誤操作時のための貸出・返却取消機能

### 7. 通知機能
- **グループ通知**: 貸出/返却完了時に、カテゴリごとの通知グループメンバー全員へメール通知
- **Issue通知**: 不具合発生時に通知グループへ自動通知
- **個人通知**: 操作者本人への確認メール送信
- **通知ログ**: 送信履歴の記録と確認

### 8. マスタ管理
- **機種・構成品管理**: 管理者による機種や構成品の登録・編集・削除機能
- **カテゴリ表示/非表示**: カテゴリの可視性を制御
- **データ初期化機能 (Admin Only)**: 全データを初期化する管理者機能

### 9. 設定
- **SMTP設定**: メール通知のためのSMTPサーバー設定
- **ユーザー管理**: ユーザーの追加・削除
- **通知グループ**: カテゴリごとの通知先メンバー設定
- **通知ログ**: 送信履歴の確認

### 10. 分析
- **稼働率分析**: 機器ごとの貸出稼働率を期間指定で計算

## 技術スタック
- **Frontend/Backend**: Python (Streamlit)
- **Database**: SQLite (`data/app.db`)
- **UI Styling**: Custom CSS (`src/styles.py`), Material Symbols Rounded
- **画像処理**: Pillow (WebP圧縮対応)
- **Environment**: Windows 11 (PowerShell)

## ディレクトリ構成
```
├── app.py                 # メインアプリケーション
├── src/
│   ├── views/             # 画面UIコンポーネント
│   │   ├── home.py        # ホーム画面
│   │   ├── loan.py        # 貸出登録画面
│   │   ├── return_view.py # 返却登録画面
│   │   ├── master.py      # マスタ管理画面
│   │   ├── settings.py    # 設定画面
│   │   ├── analytics.py   # 分析画面
│   │   ├── login.py       # ログイン画面
│   │   └── setup.py       # 初期セットアップ画面
│   ├── database.py        # データベース操作
│   ├── logic.py           # ビジネスロジック・通知処理
│   ├── auth.py            # 認証機能
│   ├── styles.py          # グローバルCSS定義
│   └── ui.py              # 共通UIコンポーネント
├── data/
│   ├── app.db             # SQLiteデータベース
│   └── uploads/           # アップロード画像
├── .streamlit/
│   └── config.toml        # Streamlit設定
├── Start_App.bat          # アプリ起動用バッチファイル
├── install_deps.bat       # 依存関係インストール用
└── requirements.txt       # Python依存関係
```

## セットアップと実行

### 必要要件
- Python 3.10+

### 初期設定 (初回のみ)
1. **依存関係のインストール**:
   ```powershell
   install_deps.bat
   ```

### アプリケーションの起動 (簡単起動)
以下のバッチファイルをダブルクリックしてください。
```powershell
Start_App.bat
```
自動的にサーバーが立ち上がり、ブラウザが開きます。

### 手動での起動
```powershell
& ".venv\Scripts\streamlit" run app.py
```

### 初期アカウント
- **Email**: `admin@example.com`
- **Password**: `admin123`

> **注意**: `admin@example.com` はRFC 2606で予約されたドメインのため、実際のメール送信はできません。本番運用時は実際のメールアドレスを持つユーザーを作成してください。

## ユーザー権限
| 権限 | 説明 |
|------|------|
| admin | 全機能にアクセス可能（マスタ管理、設定、データ初期化） |
| user | 貸出・返却操作、履歴閲覧 |
| related | 関連業者向け（限定的なアクセス） |

## 更新履歴
- **2026-01-17**: 貸出/返却時の通知グループへのグループ通知機能を追加
- **2026-01-12**: メール通知機能の改善、履歴写真表示機能追加
- **2026-01-10**: UI改善、データリセット機能追加
